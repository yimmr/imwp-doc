# 演示数据管理

{% hint style="info" %}
本节包含的功能处于试行阶段，后续可能会单独发布
{% endhint %}

### 概要

这是一个插件框架，用于制作管理主题或其他插件演示数据的插件，核心功能是实现演示数据的一键/选择填充和删除。开发思路是调用框架接口实现填充数据的功能，一般不用写删除数据的代码，这由框架自动处理。框架提供的接口无法实现需求时可参考[自定义](yan-shi-shu-ju-guan-li.md#undefined)一栏扩展功能。

**目录结构：**

* **actions**  主要开发目录\
  \-- inc  自定义PHP文件\
  \-- uploads  媒体文件\
  \-- data  JSON数据文件\
  \-- 任务文件.json&#x20;
* **languages**  多语言目录
* **src**  框架核心功能目录
* **logs**  目录下的文件用于标记已填充的数据（框架自动创建不用管）
* **index.php**  入口文件
* **其他相关文件**

{% hint style="info" %}
框架可以自动创建 `logs` 目录，填充数据后会在目录下写入文件进行登记。有以下几点需要注意：

* 新插件要删除这个目录；
* 目录存在文件时不能盲目删除，删除就不能跟踪或删除新增的数据；
* 目录为空时可以删除；
{% endhint %}

### **任务文件**

任务文件是 `actions` 目录下的 `json` 文件，文件名可以用中文或短横分隔的英文单词。

* 使用能描述所填充数据的短语做文件名；
* 唯一任务是填充一组特定数据，根据需求自由组织；
* **任务文件独立且不存在依赖关系**，即使填充数据前要先填充其他数据，也只用一个任务文件实现；

**编写任务文件**

文件内容是 `json` 对象，一般使用对象属性定义PHP变量（任务执行时使用对象的属性名和值创建变量），但一些属性有其他用途。

任务执行的PHP代码写到 `steps` 属性，支持字符串或字符串数组值，数组即每行代码一个数组成员。代码量大时可迁移到 `actions/inc` 目录下的PHP文件，然后 `inc` 属性写PHP文件名。这两个属性二选一，如果存在 `inc` 则只引入PHP文件不执行 `steps` 代码。

**不可用的对象属性**（内部创建这些名称的变量）：

* **this**  指向管理者对象
* **manager**  管理者对象，可调用方法拼接路径
* **modelSave**  保存数据对象
* **media**  媒体库对象
* **Multiple**  静态类，可调用方法按规则重复创建 n 条数据

简单的任务文件示例：

```json
{
    "data": {
        "title": "标题",
        "content": "内容",
        "type": "post",
        "_thumbnail_id": "cover.jpg",
        "tax_input": {
            "category": [
                "威威",
                {
                    "name": "武武",
                    "child": [
                        {
                            "name": "子级一",
                            "child": [
                                "子级一一"
                            ]
                        },
                        "子级二"
                    ]
                }
            ]
        },
        "meta_input": {
            "_aa": 123,
            "bbb": "dsdsf",
            "_cddf": "dsfsgfg"
        }
    },
    "steps": "$modelSave->post($data);"
}
```

要执行这个任务先在后台启动插件，然后打开 `外观 > 演示数据` 界面进行操作，任务执行时将发布一篇 `post_type = post` 的帖子，同时新增并关联一些分层术语和元数据。

{% hint style="success" %}
任务填充数据后不可重复填充，如果想修改已填充的数据应先删除，然后调整任务文件的属性值，不应直接在后台修改，这为了文件和所预览的保持一致。
{% endhint %}

示例中 `data` 属性的值跟 `wp_insert_post()` 的参数类似的， 只是框架提供了一些额外支持：可选简写带前缀的字段名（如 `post_/user_/comment_` ），部分参数的额外支持，如分层分类法/缩略图等不需要填写 ID ，直接写文件名或术语名称即可，对应的内容不存在时内部自动添加。

### 静态资源

图片、视频等将上传到媒体库的文件统一放在 `actions/uploads` 目录下，可以调用 `$media->uploadIf('filename')` 上传文件到媒体库。

任务文件中可以定义数据，如果数据比较多或者需要复用时，将JSON数据迁移到 `actions/data` 目录下，一个 `.json` 文件对应一种数据。可以调用 `$manager->data('filename')` 加载数据，此方法可将数据转为PHP数组。

### 接口参考



### 自定义

自定义数据保存不复杂，同样将PHP代码放在 `actions/inc` 目录，任务文件的规则不变。主要是不使用框架的接口保存数据，自己另实现代码逻辑，此时要在 `actions/inc` 目录增加一个 `delete.php` 文件，用于删除新增的数据，此文件将在删除数据时自动调用，文件中可访问内置变量 `$context` 和 `$filename` 。

自定义规则：

* 每成功新增一条数据，调用管理者 `$manager->logPost()` 记录数据主键，例如发布文章成功后调用方法： `$manager->logPost('post', $postid)` 。
* 删除数据的代码写在 `delete.php` ，变量 `$context` 储存未删除数据的主键，例如  `$context['post']` 可得之前记录的文章ID数组（始终是数组），删除数据后需要移除变量中对应的值。
* &#x20;内置 `$filename` 变量保存任务文件名，可用于判断当前删除的是哪个任务的数据。

简单的数据删除逻辑示例：

```php
if ($context['post'] = array_filter($context['post'], function ($id) {
    return !wp_delete_post($id, true);
})) {
    unset($context['post']);
}
```

{% hint style="warning" %}
如果不过滤 `$context` 变量值，则需要手动打开 `logs` 目录删除记录，不建议这样做，可能删错。
{% endhint %}
